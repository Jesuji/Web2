<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>간단한 지도 표시하기</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=ihsg50uuii"></script>
</head>
<body>

<div id="map" style="width:100%;height:400px;"></div>

<script>

    // URL 파라미터에서 latitude와 longitude 값을 추출하는 함수
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const latitude = parseFloat(params.get('latitude'));
        const longitude = parseFloat(params.get('longitude'));
        return { latitude, longitude };
    }

    // URL에서 좌표값을 가져옴
    const locationParams = getUrlParams();

    // 좌표값 확인 후 지도 옵션 설정
    var mapOptions = {
        center: (locationParams.latitude && locationParams.longitude)
            ? new naver.maps.LatLng(locationParams.latitude, locationParams.longitude) // URL에서 받은 좌표 사용
            : new naver.maps.LatLng(37.3595704, 127.105399), // 좌표가 없으면 기본값 사용
        zoom: 15
    };

    // 네이버 지도 초기화
    var map = new naver.maps.Map('map', mapOptions);

    // 5km 반경 내 레스토랑 정보를 가져오는 함수 (POST 방식)
    async function fetchRestaurants() {
        try {
            const lat = locationParams.latitude || 37.3595704; // URL에서 받은 값이 없으면 기본값 사용
            const lng = locationParams.longitude || 127.105399;

            // POST 방식으로 현재 좌표와 반경을 백엔드에 요청
            const response = await fetch(`http://192.168.0.24:8080/restaurants/search/location`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                    radius: 5
                })
            });

            const restaurants = await response.json();

            // 각 레스토랑의 마커를 지도에 추가
            restaurants.forEach(restaurant => {
                var marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(restaurant.latitude, restaurant.longitude),
                    map: map,
                    title: restaurant.name // 마커의 툴팁으로 이름 표시
                });

                // 마커 클릭 시 인포윈도우 표시
                var infoWindow = new naver.maps.InfoWindow({
                    content: `<div style="padding:10px;">${restaurant.name}</div>`
                });

                naver.maps.Event.addListener(marker, "click", function() {
                    infoWindow.open(map, marker);
                });
            });
        } catch (error) {
            console.error('음식점 정보를 불러오는 데 실패했습니다:', error);
        }
    }

    // 레스토랑 정보를 가져와서 지도에 표시
    fetchRestaurants();
</script>

</body>
</html>
